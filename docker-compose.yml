version: "3.8"

volumes:
  grafana-storage:
  pgdata:
  certs:
    # Using the Let's Encrypt certificates form another project on the same server. (Not creating our own ones becaue
    # Let's Encrypt requires port 80, but port 80 is already in use by that project)
    external:
      name: kensaku_certs

services:
  updater:
    build:
      context: updater
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - DASH_PGHOST=postgres
      - DASH_PGPORT=5432
      - DASH_PGDATABASE=${DASH_PGDATABASE:?err}
      - DASH_PGUSER=${DASH_PGUSER:?err}
      - DASH_PGPASSWORD=${DASH_PGPASSWORD:?err}
      - AGSI_API_KEY=${AGSI_API_KEY:?err}
      - WORKFLOWY_SESSION_ID=${WORKFLOWY_SESSION_ID:?err}
    depends_on:
      - postgres

  grafana:
    build:
      context: grafana
      dockerfile: Dockerfile
    volumes:
      - grafana-storage:/var/lib/grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${DASH_GF_SECURITY_ADMIN_PASSWORD:?err}
      - GF_SERVER_DOMAIN=${DOMAIN}
      - DASH_PGPASSWORD_GRAFANA=${DASH_PGPASSWORD_GRAFANA:?err}
      # - GF_DATE_FORMATS_FULL_DATE=DD.MM.YYYY HH:mm:ss
      - GF_DATE_FORMATS_INTERVAL_SECOND=HH:mm:ss
      - GF_DATE_FORMATS_INTERVAL_MINUTE=HH:mm
      - GF_DATE_FORMATS_INTERVAL_HOUR=DD.MM. HH:mm
      - GF_DATE_FORMATS_INTERVAL_DAY=DD.MM.
      - GF_DATE_FORMATS_INTERVAL_MONTH=YYYY-MM
      - GF_DATE_FORMATS_INTERVAL_YEAR=YYYY
    ports:
      - 3000:3000
    depends_on:
      - postgres

  postgres:
    build:
      context: postgres
      dockerfile: Dockerfile
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      # Config options depending on the environment (the ones applying everywhere should go into the config file)
      - -c
      - log_statement=${DASH_PG_LOGLEVEL:-none}
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    environment:
      # For creating the inital database
      - POSTGRES_DB=${DASH_PGDATABASE:?err}
      - POSTGRES_USER=${DASH_PGUSER:?err}
      - POSTGRES_PASSWORD=${DASH_PGPASSWORD:?err}
      # For more convenient invocation of psql
      - PGDATABASE=${DASH_PGDATABASE:?err}
      - PGUSER=${DASH_PGUSER:?err}
      - PGPASSWORD=${DASH_PGPASSWORD:?err}
    ports:
      # Forward ports for development and debugging. But only listen on localhost to make exposing them publicly by
      # accident a bit harder.
      - 127.0.0.1:5432:5432

  nginx:
    build:
      context: nginx
      dockerfile: Dockerfile
    volumes:
      - certs:/etc/nginx/ssl/certs
    restart: unless-stopped
    environment:
      - GRAFANA_HOST=grafana
      - GRAFANA_PORT=3000
      - DOMAIN=${DOMAIN:-localhost}
    ports:
      - 4000:443
    depends_on:
      - grafana
